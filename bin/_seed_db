#!/usr/bin/env coffee

MongoClient = require('mongodb').MongoClient
format = require('util').format
fs = require('fs')
_ = require('lodash')
ObjectID = require('mongodb').ObjectID
path = require('path')

mongoUri = process.env["CONTAINER_MONGO_URI"] || "mongodb://localhost/corespring-container"

console.log "mongoUri: #{mongoUri}"

seed = (collection, folder, next) ->

  collection.remove {}, ->

    files = fs.readdirSync( folder )
    files = _.filter files, (f) -> path.extname(f) == ".json"
    _.each files, (f) ->

      console.log "seeding: #{folder}/#{f}"
      contents = fs.readFileSync("#{folder}/#{f}", "utf8")
      json = processDates(JSON.parse(contents))
      json._id = new ObjectID(json._id)

      collection.insert json, (err, docs) ->

        collection.count (err, count) ->
          console.log format("count = %s", count)

        collection.find().toArray (err, results) ->
          #console.dir(results)
          next(err)

processDates = (obj) ->
  for key of obj
    obj[key] = new Date(obj[key])  if key is "$date"
    obj[key] = processDates(obj[key])  if obj[key] instanceof Object
    if obj[key] instanceof Array
      obj[key] = _.map(obj[key], (o) ->
        processDates o
      )
  obj

MongoClient.connect mongoUri, (err, db) ->

  throw err if err?

  console.log "------------> items"
  seed db.collection('items'), "mock-data/items", (err) ->
    db.close()


MongoClient.connect mongoUri, (err, db) ->

  throw err if err?

  console.log "------------> sessions"
  seed db.collection('sessions'), "mock-data/sessions", (err) ->
    db.close()
