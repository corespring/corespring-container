#!/usr/bin/env coffee

MongoClient = require('mongodb').MongoClient
format = require('util').format
fs = require('fs')
_ = require('lodash')
ObjectID = require('mongodb').ObjectID
path = require('path')
EOL = require('os').EOL

mongoUri = process.argv[2] || process.env["CONTAINER_MONGO_URI"] || "mongodb://localhost/corespring-container"

console.log "--------> mongoUri: #{mongoUri}"

seed = (collection, folder, isMultipleItems, next) ->

  collection.remove {}, ->

    files = fs.readdirSync( folder )
    files = _.filter files, (f) -> path.extname(f) == ".json"
    _.each files, (f) ->

      console.log "seeding: #{folder}/#{f}"
      contents = fs.readFileSync("#{folder}/#{f}", "utf8")

      if isMultipleItems
        items = contents.trim().split(EOL).map (item) -> processId(JSON.parse(item.trim()))
        #console.log "seeding: #{items.length} items into #{collection} example #{JSON.stringify(items[0])}"
      else
        json = processDates(JSON.parse(contents))
        json._id = new ObjectID(json._id)
        items = [json]

      collection.insert items, (err, docs) ->

        collection.count (err, count) ->
          console.log format("count = %s", count)

        collection.find().toArray (err, results) ->
          #console.dir(results)
          next(err)

###
# Assign the oid to the id
# Without this conversion the item
# is not inserted into the collection
###
processId = (item) ->
 if item._id.$oid
   item._id = item._id.$oid
 item

processDates = (obj) ->
  for key of obj
    if key is "$date"
      obj = new Date(obj[key])
    obj[key] = processDates(obj[key]) if obj[key] instanceof Object
    if obj[key] instanceof Array
      obj[key] = _.map(obj[key], (o) ->
        processDates o
      )
  obj

MongoClient.connect mongoUri, (err, db) ->

  throw err if err?

  console.log "------------> items"
  seed db.collection('items'), "mock-data/items", false, (err) ->
    db.close()


MongoClient.connect mongoUri, (err, db) ->

  throw err if err?

  console.log "------------> sessions"
  seed db.collection('sessions'), "mock-data/sessions", false, (err) ->
    db.close()


MongoClient.connect mongoUri, (err, db) ->

  throw err if err?

  console.log "------------> ccstandards"
  seed db.collection('ccstandards'), "mock-data/standards", true, (err) ->
    db.close()
