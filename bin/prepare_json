#!/usr/bin/env coffee


###
Create json files from the json.ejs files
###
ejs = require('ejs')
wrench = require('wrench')
path = require('path')
fs = require('fs')
_ = require('lodash')

files = wrench.readdirSyncRecursive 'mock-data'
ejsFiles = _.filter files, (p) -> path.extname(p) == ".ejs"

xmlreader = (currentPath) ->

  read : (relativePath) ->
    console.log "read: #{currentPath} --> #{relativePath}"

    dir = path.dirname(currentPath)
    resolvedPath = "#{dir}/#{relativePath}"
    #resolvedPath = path.relative(currentPath, relativePath)

    console.log "resolved to: #{resolvedPath}"

    xml = fs.readFileSync(resolvedPath).toString()
    xml = xml.replace(/\n/g, '\\n').replace(/"/g, "\\\"")
    console.log xml
    xml


processEjs = (p) ->
  cwd = process.cwd()
  contents = fs.readFileSync(p).toString()
  console.log "contents: #{contents}, type: #{typeof(contents)}"
  rendered = ejs.render(contents, { helper: xmlreader(p)})
  savePath = p.replace(".ejs", "")
  fs.writeFileSync( savePath, rendered)

prepare = (root) ->

  files = fs.readdirSync(root)
  ejsFiles = _.filter files, (f) -> path.extname(f) == ".ejs"

  ejsFiles = _.map ejsFiles, (f) -> "#{root}/#{f}"

  _.each ejsFiles, (p) -> processEjs(p)

prepare("mock-data/items")
